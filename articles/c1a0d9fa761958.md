---
title: "boto3 ã§ S3 ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ timestamp ã§æ¡ä»¶æ¤œç´¢ã™ã‚‹ã€‚"
emoji: "ğŸŸ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws,S3,boto3]
published: false
---

## ã¯ã˜ã‚ã«
S3 ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€`boto3` ã§ã€æŒ‡å®šã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰ã€ç¾æ™‚åˆ»ã¾ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’ã—ã¦ã„ãã¾ã™ã€‚
èƒŒæ™¯ã¨ã—ã¦ã€å‡¦ç†ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã—ã€å¾Œç¶šå‡¦ç†ã«é€£æºã™ã‚‹ãŸã‚ã§ã™ã€‚

## ã‚„ã‚ŠãŸã„ã“ã¨ã‚¤ãƒ¡ãƒ¼ã‚¸

## ç›®æ¬¡

1. ã¯ã˜ã‚ã«ã€å‡¦ç†ã—ãŸã„ S3 Bucket ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ AWS CLI `$ aws s3 ls <bucket name>` ã§ç¢ºèªã™ã‚‹
2. `boto3` ã§ã€æœ€çµ‚æ›´æ–°æ—¥ã€`LastModified` ã‚’ keyã«ã—ã¦ã€æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ã¿å–å¾—ã™ã‚‹
3. å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´ã—ã€å¾Œç¶šå‡¦ç†ã«é€£æºã™ã‚‹ãŸã‚ã«ã€æ–‡å­—åˆ—èª¿æ•´ã™ã‚‹


## æ‰‹é †

### 1. ã¯ã˜ã‚ã«ã€å‡¦ç†ã—ãŸã„ S3 Bucket ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ `$ aws s3 ls <bucket name>` ã§ç¢ºèªã™ã‚‹
   ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã‹ã‚‰ã€**2021-11-06 14:00:00** ä»¥é™ã®æ™‚é–“ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚

```bash:aws CLI
$ aws s3 ls s3://bucketid001
2021-11-06 13:36:16       7613 data_211021.json
2021-11-06 13:36:17       7613 data_211022.json
2021-11-06 13:36:16       7613 data_211023.json
2021-11-06 13:36:16       7613 data_211024.json
2021-11-06 13:36:16       7530 data_211025.json
2021-11-06 18:08:57        115 response.json
2021-11-06 18:08:57        115 response2.json
2021-11-06 18:08:57        115 response3.json
2021-11-06 18:08:57          0 test.sql
2021-11-06 18:08:57        264 user.json
2021-11-06 18:08:57       3206 user.sql
```

### 2.`boto3` ã§ã€æœ€çµ‚æ›´æ–°æ—¥ã€`LastModified` ã‚’ keyã« ã—ã¦ã€æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ã¿å–å¾—ã™ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ **2021-11-06 14:00:00** ä»¥é™ã§å–å¾—ã™ã‚‹

```python:api/models/storage.py
# modelå´
import datetime
import boto3

class Storage(object):
    """
    AWS S3 Bucket æ“ä½œã™ã‚‹ model
    """

    def __init__(self, client: str, bucket_name: str, region: str):
        """ initialization parameter

        params
        ------
            client(str): s3
            bucket_name(str): choice bucket name
            region(str): Region code
        """
        self.client = boto3.client(client)
        self.resource_bucket = boto3.resource(client)
        self.bucket_name = bucket_name
        self.region = region

    # ç•¥ ...

    def get_timestamp_file1(self) -> dict:
        """
        Retrieve all the data in the specified bucket and return it in a dictionary with the value of last modified.

        return
        ------
        ã€€ã€€dict: {'file name': 'LastModified'}
          ã€€ex) {'data_211021.json': '2021-11-06 09:35:53'}
        """

        file_last_modified_dict = {}

        my_bucket = self.resource_bucket.Bucket(self.bucket_name)

        for obj in my_bucket.objects.all():
          ã€€# æ—¥æœ¬æ™‚é–“ã«èª¿æ•´ã™ã‚‹ãŸã‚ã«ã€parameter ã« `hours=9` ã‚’æŒ‡å®š
            obj_last_modified = str(obj.get()['LastModified'] + datetime.timedelta(hours=9))[0:-6]
            file_last_modified_dict[obj.key] = obj_last_modified

        return file_last_modified_dict

    def get_files_up_specified_timestamp(self, file_dict, filter_time='2021-11-06 14:00:00') -> list:
        """ Get files up to the specified timestamp.

        params
        ------
          file_dict(dict): key: file_name, value: Last modified
          filter_time(str): The time of the timestamp you want to retrieve.

        return
        ------
            List of retrieved files
        """
        print(f"*** since: {filter_time} ***")

        filter_files = []
        for file_name, timestamp in file_dict.items():
            if timestamp >= filter_time:
                print(f"file: {file_name:20} timestamp: {timestamp}")
                filter_files.append(file_name)
        print('-' * 20)

        return filter_files
```

```python:api/controllers/storage_controller.py
# controller ã§å‡¦ç†
import os

from dotenv import load_dotenv

from api.models import storage
from config import const


def s3_storage_management():
    """ aws s3 management """

    # call .env
    load_dotenv()
    region = os.environ.get('AWS_REGION')

    management_storage = storage.Storage(client=const.CLIENT, # s3
                                         bucket_name=const.BUCKET_NAME, # bucketid001
                                         region=region) # æŒ‡å®šãƒªãƒ¼ã‚¸ãƒ§ãƒ³


    file_dict = management_storage.get_timestamp_file1()
    management_storage.get_files_up_specified_timestamp(file_dict)

```


```python:main.py
# å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
import api.controllers.storage_controller

if __name__ == '__main__':
    api.controllers.storage_controller.s3_storage_management()
```

- ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã®çµæœç¢ºèª
  æŒ‡å®šã—ãŸã€2021-11-06 14:00:00 ä»¥é™ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```bash
file: response.json        timestamp: 2021-11-06 18:08:57
file: response2.json       timestamp: 2021-11-06 18:08:57
file: response3.json       timestamp: 2021-11-06 18:08:57
file: test.sql             timestamp: 2021-11-06 18:08:57
file: user.json            timestamp: 2021-11-06 18:08:57
file: user.sql             timestamp: 2021-11-06 18:08:57
```

## ã¾ã¨ã‚
`boto3` ã§ã€æ ¼ç´ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ—¥(`LastModified`) ã‚’ key ã«ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸ!
æ¬¡å›ã¯ã€å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã§ã€SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ãŸã¨æ€ã„ã¾ã™ã€‚

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ!!

## å‚è€ƒ

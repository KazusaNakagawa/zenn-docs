---
title: "ã€Pythonã€‘loggre ãƒ­ã‚°å‡ºåŠ›ã‚’ã€JSONå½¢å¼ã§è¨­å®šã™ã‚‹"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Python]
published: true
---

## ã¯ã˜ã‚ã«

ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹Handler ã‚’è¤‡æ•°è¨­å®šã™ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¦ã„ãã¾ã™ã€‚

ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€ã€Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã€ã‚’åŒæ™‚ã«ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹ã“ã¨ã§ã™ !!

## çµŒç·¯

å®Ÿé‹ç”¨ã™ã‚‹ã¨ãã¯ã€ãƒ­ã‚°å‡ºåŠ›ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¤‡æ•°è¨­å®šã™ã‚‹å¿…è¦æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ç•°å¸¸æ¤œçŸ¥ã§èª¿æŸ»ã™ã‚‹æ™‚ã€æ„å›³ã—ãŸå®Ÿè¡Œå‡¦ç†ãŒã§ãã¦ã„ã‚‹ã‹ç›£è¦–ã™ã‚‹æ™‚ãªã©ã§ã™ã€‚

- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›: StreamHandler
- ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›: FileHandler

ä»–ã«ã‚‚ã€`SysLogHandler`, `SocketHandler`, `TimedRotatingFileHandler` ãªã©ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

## æ‰‹é †

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€`StreamHandler`, `FileHandler` ã® handler ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥è¨˜è¿°ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ã€å‘¼ã³å‡ºã—å´ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰ãˆã‚‹ã ã‘ã§ã€ä»»æ„ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ãˆã‚‹ã“ã¨ã§ã™ã‹ã­ã€‚

1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ã‚°å‡ºåŠ›ã—ãŸã„è¨­å®šã«è¨˜è¿°ã™ã‚‹
2. å‘¼ã³å‡ºã—å´ã§ã€logger åã‚’æŒ‡å®š
3. ãƒ­ã‚°ãŒã€æ„å›³ã—ãŸçµæœã§å‡ºåŠ›ã§ãã‚‹ã‹æ¤œè¨¼

## è©³ç´°

```yaml:ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« ( conf.json )
{
  "version": 1,
  "formatters": { ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€... 1
    "detailed": {
      "class": "logging.Formatter",
      "format": "%(asctime)s %(name)-15s %(levelname)-13s %(message)s",
      "datefmt": "%Y-%m-%d %H:%M:%S"
    }
  },
  "handlers": {
    "console": {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€... 2
      "class": "logging.StreamHandler",
      "level": "INFO",
      "formatter": "detailed"
    },
    "file": {
      "class": "logging.FileHandler",
      "filename": "log/mplog.log",
      "mode": "a",
      "formatter": "detailed"
    },
    "testfile": {
      "class": "logging.FileHandler",
      "filename": "log/testfile.log",
      "level": "ERROR",
      "mode": "a",
      "formatter": "detailed"
    },
    "errors": {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€... 3
      "class": "logging.FileHandler",
      "filename": "log/mplog-errors.log",
      "mode": "a",
      "level": "ERROR",
      "formatter": "detailed"
     }
  },
  "loggers": {ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€... 4
    "testfile": {
      "handlers": ["testfile"]
    }
  },
  "root": {                                                             ... 5
    "level": "DEBUG",
    "handlers": ["console", "file", "errors"]
  }
}
```

### 1. formatters : å‡ºåŠ›ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®š

- detailed: å¥½ããªåå‰ã‚’ã¤ã‘ã¦formatter åã‚’ã¤ã‘ã‚Œã¾ã™
- class: Formatter ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒ‡å®š
- format: ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
- datefmt: `%(asctime)s` ã®è¡¨ç¤ºã‚’èª¿æ•´

    ```yaml
      "formatters": {
        "detailed": {
          "class": "logging.Formatter",
          "format": "%(asctime)s %(name)-15s %(levelname)-13s %(message)s",
          "datefmt": "%Y-%m-%d %H:%M:%S"
        }
    ```


### 2. handlers: å‡ºåŠ›ã™ã‚‹é …ç›®ã‚’è¨­å®š( StreamHandler )

- console: å¥½ããª handler å
- level: å‡ºåŠ›ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
- formatter: formatters ã§æŒ‡å®šã—ãŸã„ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå

    ```yaml
      "handlers": {
        "console": {
          "class": "logging.StreamHandler",
          "level": "INFO",
          "formatter": "detailed"
        },
    ```


### 3. handlers: å‡ºåŠ›ã™ã‚‹é …ç›®ã‚’è¨­å®š ( FileHandler )

- errors: å¥½ããª handler å
- filename:  <ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹>/< ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å>
- mode: æ›¸ãè¾¼ã‚€ãƒ¢ãƒ¼ãƒ‰  w: æ–°è¦æ›¸è¾¼ã¿ã€a: è¿½è¨˜ ãªã©

    ```yaml
    "errors": {
        "class": "logging.FileHandler",
        "filename": "log/mplog-errors.log",
        "mode": "a",
        "level": "ERROR",
        "formatter": "detailed"
       }
    ```


### 4. loggers: logger åã«æŒ‡å®š

   logger åã‚’ æŒ‡å®šã™ã‚‹ã¨ã€å‡ºåŠ›åæ˜ ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®è¨­å®šã ã¨ `testfile` ã® handler ãŒé¸æŠã•ã‚Œã¾ã™ã€‚

- testfile: å¥½ããªåå‰ã‚’ã¤ã‘ã‚‹
- handlers: handlers ã§ã¤ã‘ãŸåå‰ã®è¨­å®šã‚’æŒ‡å®š

    ```yaml
      "loggers": {
        "testfile": {
          "handlers": ["testfile"]
        }
    ```

    å‘¼ã³å‡ºã—å´ã® logging ã§æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€`"testfile"` ãŒæ¡ç”¨ã•ã‚Œã¾ã™

    ğŸ‘‡ã“ã‚“ãªæ„Ÿã˜

    ```python
    import logging

    logger = logging.getLogger("testfile")
    ```

### 5. root: è¨­å®š

- handlers ã« ãƒ­ã‚°å‡ºåŠ›ã—ãŸã„å¯¾è±¡åã‚’ã€ãƒªã‚¹ãƒˆæ ¼ç´ã™ã‚‹ã“ã¨ã§ã€å¸¸ã«ãƒ­ã‚°å‡ºåŠ›ã«åæ˜ ã•ã‚Œã¾ã™

    ```yaml
      "root": {
        "level": "DEBUG",
        "handlers": ["console", "file", "errors"]
      }
    ```


## ãƒ­ã‚°ç”Ÿæˆãƒ»å‡ºåŠ›

main() ã§å‘¼ã³å‡ºã—å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚ç´°ã‹ã„èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚

```python:main.py
import configparser
import os
import json
import logging

import logging.config

# å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
_EXEC_FILE_NAME = os.path.basename(__file__)[:-3]

def read_conf_file(conf_file='conf/conf.json'):
    """ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã‚€ """
    with open(conf_file, 'r', encoding='utf-8') as f:
        f_ = json.load(f)
        logging.config.dictConfig(f_)

def get_logger(logger_='simpleDefault'):
    """ ãƒ­ã‚¬ãƒ¼ç”Ÿæˆ """
    return logging.getLogger(logger_)

def set_conf(conf_file='conf/msg_format.ini'):
    """ Read the format file you set. """
    conf = configparser.ConfigParser()
    conf.read(conf_file)
    return conf

def get_conf(conf, sec: str, option: str, format1=None, format2=None):
    """ Get the section name and key. """
    conf = conf.get(section=sec, option=option)
    return conf.format(format1, format2)

def main():
    """ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« """

    # formater ãƒ•ã‚¡ã‚¤ãƒ«å‘¼ã³å‡ºã—
    read_conf_file(conf_file='conf/conf.json')

    # logger åã‚’è¨­å®š
    logger = get_logger(logger_=_EXEC_FILE_NAME)

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
    set_conf_ = set_conf(conf_file='conf/msg_format.ini')

    # ------------------------
    # ãƒ­ã‚°å‡ºåŠ›
    # ------------------------

    # Debug
ã€€ã€€ msg1 = get_conf(conf=set_conf_, sec='message', option='DAP0001', format1=[1, 2, 3], format2=[1, 2, 3])
    logger.debug(msg1)

    # Info
    msg2 = get_conf(conf=set_conf_, sec='message', option='IAP0001', format1=[1, 2, 3], format2=[1, 2, 3])
    logger.info(msg2)

    # Warning
    msg3 = get_conf(conf=set_conf_, sec='message', option='WAP0001', format1=[1, 2, 3], format2=[1, 2, 3])
    logger.warning(msg3)

    # Error
    msg4 = get_conf(conf=set_conf_, sec='message', option='EAP0001', format1=[1, 2, 3], format2=[1, 2, 3])
    logger.error(msg4)

    # Critical
    msg5 = get_conf(conf=set_conf_, sec='message', option='CAP0001', format1=[1, 2, 3], format2=[1, 2, 3])
    logger.critical(msg5)

if __name__ == '__main__':
    main()

```

- ãƒ­ã‚°å‡ºåŠ›. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```ini:msg_format.ini
[message]
DAP0001=Debug Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]} err_id: {1[0]}
DAP0002=Debug Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]}
DAP0003=Debug Message user_id: {0[0]} tr_id: {0[1]}

IAP0001=Info Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]} err_id: {1[0]}
IAP0002=Info Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]}
IAP0003=Info Message user_id: {0[0]} tr_id: {0[1]}

WAP0001=Warning Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]} err_id: {1[0]}
WAP0002=Warning Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]}
WAP0003=Warning Message user_id: {0[0]} tr_id: {0[1]}

EAP0001=Error Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]} err_id: {1[0]}
EAP0002=Error Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]}
EAP0003=Error Message user_id: {0[0]} tr_id: {0[1]}

CAP0001=Critical Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]} err_id: {1[0]}
CAP0002=Critical Message user_id: {0[0]} tr_id: {0[1]} param_id: {0[2]}
CAP0003=Critical Message user_id: {0[0]} tr_id: {0[1]}
```

## å®Ÿè¡Œçµæœ

ã‚„ã‚ŠãŸã„äº‹ãŒã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™!

console: **INFO** ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›

```bash
2021-12-11 20:12:40 format          INFO          Info Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          WARNING       Warning Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          ERROR         Error Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          CRITICAL      Critical Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
```

mplog.log: **DEBUG** ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã‚’ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

```bash
2021-12-11 20:12:40 format          DEBUG         Debug Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          INFO          Info Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          WARNING       Warning Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          ERROR         Error Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          CRITICAL      Critical Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
```

mplog-error.log: **ERROR** ä»¥ä¸Šã‚’ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

```bash
2021-12-11 20:12:40 format          ERROR         Error Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
2021-12-11 20:12:40 format          CRITICAL      Critical Message user_id: 1 tr_id: 2 param_id: 3 err_id: 1
```

## ã¾ã¨ã‚

ä»Šå›ã§ãƒ­ã‚°å‡ºåŠ›è¨­å®šã«é–¢ã—ã¦ã¯ç†è§£ã§ããŸã‹ãªã£ã¨æ€ã„ã¾ã™ã€‚
å¾Œã¯ã€ä»¥ä¸‹ã‚’é€²ã‚ã¦ã„ãã¨è‰¯ã•ãã†ã§ã™!!

- ã‚¯ãƒ©ã‚¹åŒ–ã—ã¦ä½¿ã„ã‚„ã™ãæ”¹å¤‰
- é‹ç”¨ã—ã‚„ã™ã„ã‚ˆã†ã«çš„ç¢ºãªç®‡æ‰€ã«ã€ãƒ­ã‚°å‡ºåŠ›ã‚’è¨­å®š

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ!

## å‚è€ƒ

- [Logging Cookbook - Python 3.10.1 documentation](https://docs.python.org/ja/3/howto/logging-cookbook.html#multiple-handlers-and-formatters)
- [Logging Cookbook - Python 3.10.1 documentation](https://docs.python.org/ja/3/howto/logging-cookbook.html#:~:text=q%20%3D%20Queue()%0A%20%20%20%20d%20%3D%20%7B-,%27version%27%3A%201%2C,-%27formatters%27%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%27detailed%27%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27class)
- å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª:  [GitHub try-docs/src/conf_logger/â†—ï¸](https://github.com/KazusaNakagawa/try-docs/tree/develop/src/conf_logger) ã„ã‚ã„ã‚è©¦ã—ã¦ã„ã‚‹ã®ã§å‚è€ƒç¨‹åº¦ã§ã™

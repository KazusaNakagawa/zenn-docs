---
title: "ã€AWS S3ã€‘ Python boto3 ã‚’ä½¿ã„æ“ä½œã—ã¦ã¿ã‚‹"
emoji: "ğŸ”„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, S3, Python, boto3]
published: true
---

## ã¯ã˜ã‚ã«
AWS 3S ã‚’ Python `boto3` ã‚’ä½¿ã£ã¦ Bucket ä½œæˆã‹ã‚‰æ“ä½œã—ã¦ã¿ã¾ã—ãŸã€‚
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°åãå‡ºã—ãªã©è’ã„ã®ã§ãƒ„ãƒƒã‚³ãƒŸã©ã“ã‚ã‚ã‚‹ã‹ã¨ã€‚
åŠ›ä¸è¶³ãªã®ã§ã€å¼•ãç¶šãå®Ÿè£…ã¯ç¶™ç¶šã—ã¦ç¶šã‘ã¦ã„ãã¾ã™!!

ã¨ã‚Šã‚ãˆãšã€æ„å›³ã—ãŸå‹•ä½œã¯å®Ÿè£…ã§ããŸã®ã§æµã‚Œã‚’æ®‹ã—ã¦ãŠã“ã†ã‹ã¨ã€‚


## ã§ããŸã“ã¨
- S3 ãƒãƒƒã‚±ãƒƒãƒˆ:ã€ç”Ÿæˆ / å‰Šé™¤ã€‘
- S3 ãƒ•ã‚¡ã‚¤ãƒ«:ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ / å‰Šé™¤ã€‘


## å¾Œã«è©¦ã—ãŸã„ã“ã¨

- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ãƒ»å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- `response` ã®å€¤ã‚’ä½¿ã£ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹
- `mock` ã‚‚ã‚„ã£ã¦ã¿ãŸã„



## å‹•ä½œç’°å¢ƒ

```bash
- Mac M1
- Python 3.8

# è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- boto3
```

## ãƒªãƒã‚¸ãƒˆãƒª
è‰²ã€…è©¦ã—ã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã«ãªã‚‹ã®ã§ã€æœ¬è¨˜äº‹ã§æ›¸ã„ãŸå‹•ä½œä»¥å¤–ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ğŸ™

- [python_test_fixture](https://github.com/KazusaNakagawa/python_test_fixture)

## å‰ææ¡ä»¶

- AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚ã‚Š
- AWS IMAä½œæˆæ¸ˆ


## å‰å‡¦ç†
ãƒ­ãƒ¼ã‚«ãƒ«ã§ã€IMAãƒ¦ãƒ¼ã‚¶ã®è¨­å®šãŒå¿…è¦ã ã£ãŸã®ã§ã€`AWS CLI` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚
ä»–ã«ã‚‚ã€ç’°å¢ƒå¤‰æ•°ã«æŒãŸã›ã¦ IMAãƒ¦ãƒ¼ã‚¶ã‚’å‘¼ã³å‡ºã™æ–¹æ³•ãŒã‚ã‚Šãã†ã§ã—ãŸãŒã€è©¦ã—ã¦ã¾ã›ã‚“ãƒ¼


### AWS CLI ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ [#1](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/install-cliv2-mac.html)

* macOS pkg ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

  æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® **AWS CLI** ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«


* ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’æ‰‹å‹•ã§ä½œæˆ `PATH` ã‚’é€šã™

```bash:bash
$ sudo ln -s /folder/installed/aws-cli/aws /usr/local/bin/aws
$ sudo ln -s /folder/installed/aws-cli/aws_completer /usr/local/bin/aws_completer
```


* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æ¤œè¨¼

```bash:bash
$ which aws
/usr/local/bin/aws

$ aws --version
aws-cli/2.2.36 Python/3.8.8 Darwin/20.6.0 exe/x86_64 prompt/off
```


### [Configuration](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html#configuration) ã®è¨­å®š

AWS CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ä»¥å‰ä½œæˆã—ã¦ã„ãŸ**IAMãƒ¦ãƒ¼ã‚¶**(ä½œæˆæ–¹æ³•ã¯å‰²æ„›)ã§aws ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚


```bash:bash
# å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
$ aws configure

# èã‹ã‚Œã‚‹é …ç›®ã‚’å…¥åŠ›
AWS Access Key ID [None]: <Access Key ID> # IAM ã®ã€€key
AWS Secret Access Key [None]: <Secret Access Key> # IAM ã®ã€€key
Default region name [None]: ap-northeast-1 # #2ã‚’å‚è€ƒã«tokyoã‚’é¸æŠ
Default output format [None]: json # ã¨ã‚Šã‚ãˆãš json
```


## ãƒ„ãƒªãƒ¼æ§‹é€ 

- ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿè£…ã—ã¾ã—ãŸ!
```bash:tree
â”œâ”€â”€ api
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ models
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ bucket.py
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ logger_tool.py
â”‚Â Â  â”‚Â Â  â””â”€â”€ time.py
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â””â”€â”€ const.py
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ test.sql
â”‚Â Â  â”œâ”€â”€ user.json
â”‚Â Â  â””â”€â”€ user.sql
â”œâ”€â”€ log
â”‚Â Â  â””â”€â”€ bucket.log
â”œâ”€â”€ main.py

```

## ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«

S3 Bucket ã‚’æ“ä½œã™ã‚‹ model ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
åŸºæœ¬ `Bucket model` ã«æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ãäºˆå®šã§ã™!!

ä»Šã¯ã€**Bucket ä½œæˆãƒ»å‰Šé™¤**ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤**ã‚’å®Ÿè£…ã—ã¾ã—ãŸ!
ãƒ­ã‚°å–å¾—ã€ä¾‹å¤–å‡¦ç†ãŒç”˜ã„ã¨æ„Ÿã˜ã¦ãŠã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšé€²ã‚ã¾ã™ã€‚

`logger` ãŒå¤šãã¦ã¿ã«ãã„...ã€‚

bucket å‰Šé™¤ã‚‚ä¸€æ‹¬ã˜ã‚ƒãªãã¦ã€æŒ‡å®š bucket ã®ã¿å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ããŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚


```python:api/models/bucket.py
import boto3

from botocore.exceptions import ClientError

from api.models import logger_tool
from config import const


class Bucket(object):

    def __init__(self, client: str, bucket_name: str, region: str):
        """

        params
        ------
        client(str): s3
        bucket_name(str): choice bucket name
        region(str): Region code
        """
        self.client = boto3.client(client)
        self.resource_bucket = boto3.resource(client)
        self.bucket_name = bucket_name
        self.region = region

    def is_bucket_check(self, bucket_name: str, max_key: int):
        """
        ä½œæˆã™ã‚‹bucket ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹

        :return:
            bucketãŒã‚ã‚‹æ™‚ã¯bucketã‚’ä½œæˆã—ãªã„
        """
        # TODO:ã€æš«å®šã€‘ä¾‹å¤–ã§bucketæœ‰ç„¡ã®åˆ‡ã‚Šåˆ†ã‘ã‚‹æ–¹æ³•ã¯é¿ã‘ãŸã„
        try:
            response = self.client.list_objects_v2(
                Bucket=bucket_name,
                MaxKeys=max_key,
            )
            return True

        except ClientError as ex:
            logger_tool.error(
                action='bucket check',
                status='error',
                bucket_name=bucket_name,
                ex=ex
            )
            return False

    def create_bucket(self):
        """ S3 ã« bucket ã‚’ä½œæˆã™ã‚‹ """

        logger_tool.info(
            action='create',
            status='run',
            bucket_name=self.bucket_name
        )

        if not self.is_bucket_check(self.bucket_name, 2):
            self.client.create_bucket(
                Bucket=self.bucket_name,
                CreateBucketConfiguration={'LocationConstraint': self.region}
            )
            logger_tool.info(
                action='create',
                status=200,
                bucket_name=self.bucket_name
            )

    def upload_data(self, bucket_name: str, upload_data: str):
        """
        1 ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹

        params
        ------
        upload_data: ex) sample.png

        """
        key = upload_data.split('/')[-1]

        logger_tool.info(
            action='upload',
            status='run',
            bucket_name=bucket_name,
            data=key,
        )

        with open(upload_data, 'rb') as upload_data_file:
            self.resource_bucket.Bucket(bucket_name).put_object(Key=key, Body=upload_data_file)

        logger_tool.info(
            action='upload',
            status=200,
            bucket_name=bucket_name,
            data=key,
        )

    def delete_data(self, bucket_name: str, delete_data: str):
        """
        bucketã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        """

        key = delete_data.split('/')[-1]

        logger_tool.info(
            action='delete',
            status='run',
            bucket_name=bucket_name,
            data=key,
        )
        try:
            response = self.client.delete_object(
                Bucket=bucket_name,
                Key=key,
            )
            return response

        except ClientError as ex:
            logger_tool.error(
                action='delete data',
                status=404,
                bucket_name=bucket_name,
                ex=ex
            )

        logger_tool.info(
            action='delete',
            status=204,
            bucket_name=bucket_name,
            data=key,
        )

    def delete_all_buckets(self):
        """
        å…¨ã¦ã® bucketã‚’å‰Šé™¤ã™ã‚‹
        """
        
        buckets = list(self.resource_bucket.buckets.all())

        if buckets:
            logger_tool.info(
                action='delete',
                status='run',
                bucket_name=self.bucket_name
            )

            response = [key.delete() for key in self.resource_bucket.buckets.all()]

            logger_tool.info(
                action='delete',
                status=204,
                bucket_name=self.bucket_name
            )
            return response

```

### ãƒ­ã‚°åãå‡ºã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š

`{ key: value }` ã§å‡ºåŠ›ã—ãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š 

ãƒ­ã‚°åãå‡ºã—ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¿æ•´ãƒ»è¡Œæ•°ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å…¥ã‚Œã¦ã¿ãŸã‹ã£ãŸã‚“ã§ã™ãŒå‰²æ„›ã€‚
è¿½ã€…ã§ãã‚Œã°ã„ã„ãªã£ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚


```python:api/models/logger_tool.py
import logging

from api.models import time
from config import const

from pathlib import Path

Path(const.LOGFILE_PATH).mkdir(exist_ok=True)
logging.basicConfig(filename=Path(f"{const.LOGFILE_PATH}{const.LOG_FILE}"), level=logging.INFO)
logger = logging.getLogger(__name__)


def error(action, status, bucket_name: str, ex):
    logger.error({
        'time': time.datetime_now(),
        'action': action,
        'status': status,
        'bucket name': bucket_name,
        'except': ex,
    })


def info(action, status, bucket_name: str, data=None):
    logger.info({
        'time': time.datetime_now(),
        'action': action,
        'status': status,
        'bucket name': bucket_name,
        'data': data,
    })


```

### ãƒ­ã‚°åãå‡ºã—æ™‚é–“ã‚’å–ã‚Šå‡ºã™ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«

ãƒ­ã‚°åãå‡ºã—æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’èª¿æ•´ã€‚

```python:api/models/time.py
import datetime


def datetime_now():
    return datetime.datetime.now().isoformat()[:19]

```

```python:result
# ç§’ã¾ã§å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´
>>> '2021-09-12T23:42:32'
```

### const

å®šæ•°ã¨ã—ã¦ã¾ã¨ã‚ãŸã‹ã£ãŸã®ã§ã€ä¸€æ‹¬ã«ã¾ã¨ã‚ãŸå½¢ã§ã™ã€‚
å³å¯†ã«ã¯ã€å‘¼ã³å‡ºã—ãŸæ™‚ã«ã€æ›¸ãæ›ãˆã§ãã¡ã‚ƒã†ã®ã§ã‚ã—ã‹ã‚‰ãšã€‚


```python:config/const.py
# å®Ÿè¡Œã¯ 0: False, 1: True ã§åˆ‡ã‚Šåˆ†ã‘
BUCKET_CREATE = 1
BUCKET_DELETE = 1

UPLOAD = 0
DELETE = 0

# ãƒ­ã‚°å‡ºåŠ›
LOGFILE_PATH = 'log/'
LOG_FILE = 'bucket.log'

# AWS
CLIENT = 's3'
BUCKET_NAME = 'testbucket'
TOKYO_REGION = 'ap-northeast-1'

```

### main

`main.py` ã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã—ãŸã€‚
ã»ã‚“ã¾ã§ã™ã¨ã€ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦å®šæœŸå®Ÿè¡Œã®ã‚¸ãƒ§ãƒ–ã‚’çµ„ã‚€ã‚“ã§ã—ã‚‡ã†ãŒã‚„ã£ãŸäº‹ãªã„ã®ã§ä¿ç•™ã€‚ãã‚Œã‹ã€`lambad` ã§å®Ÿè¡Œã™ã‚‹ã‚“ã§ã™ã‹ã­ğŸ¤”

ã¾ãŸã€æ¬¡å›ä»¥é™è©¦ã—ã¦ã¿ã‚‹ã®ã‚‚é¢ç™½ãã†ã§ã™www

```python:main.py
from api.models.bucket import Bucket
from config import const


def bucket_main():
    data_list = ['data/user.sql', 'data/user.json']

    # create instance
    bucket1 = Bucket(client=const.CLIENT, bucket_name=const.BUCKET_NAME, region=const.TOKYO_REGION)

    if const.BUCKET_CREATE:
        bucket1.create_bucket()

    if const.UPLOAD:
        for data in data_list:
            bucket1.upload_data(bucket_name=const.BUCKET_NAME, upload_data=data)

    if const.DELETE:
        for data in data_list:
            bucket1.delete_data(bucket_name=const.BUCKET_NAME, delete_data=data)

    if const.BUCKET_DELETE:
        bucket1.delete_all_buckets()


def main():
    bucket_main()


if __name__ == '__main__':
    main()

```



## å†…å®¹èª¬æ˜


### ãƒ­ã‚°åãå‡ºã—ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™

ä»Šå›ã¯ `key: value` ã§ãƒ­ã‚°ã‚’åãå‡ºã™ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚


`api.models.logger_tool` ãŒåãå‡ºã•ã‚Œã¦ã„ã‚‹ã®ãŒã„ã‚„ã§ã™ã­ã€‚
ã“ã“ã¯æ›¸ãå‡ºã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ­ã‚°åãå‡ºã—ã§ãã‚‹ã‚ˆã†ã«èª¿æ•´ã—ãŸã„ã§ã™ã€‚

æ”¹å–„å¿…é ˆã§ã™ã€‚


```log:bucket.log
INFO:botocore.credentials:Found credentials in shared credentials file: ~/.aws/credentials
INFO:api.models.logger_tool:{'time': '2021-09-12T22:33:34', 'action': 'create', 'status': 'run', 'bucket name': 'testbucket-0911-2'}
ERROR:api.models.logger_tool:{'time': '2021-09-12T22:33:34', 'action': 'bucket check', 'status': 'error', 'bucket name': 'testbucket-0911-2', 'except': NoSuchBucket('An error occurred (NoSuchBucket) when calling the ListObjectsV2 operation: The specified bucket does not exist')}
INFO:api.models.logger_tool:{'time': '2021-09-12T22:33:36', 'action': 'create', 'status': 200, 'bucket name': 'testbucket-0911-2'}
INFO:botocore.credentials:Found credentials in shared credentials file: ~/.aws/credentials
INFO:api.models.logger_tool:{'time': '2021-09-12T22:33:58', 'action': 'create', 'status': 'run', 'bucket name': 'testbucket-0911-2'}
ãƒ»ãƒ»ãƒ»
```


## ã¾ã¨ã‚
ã¾ã ã¾ã ã€å®Ÿç”¨ã§ã¯ä½¿ãˆãªã„ãƒ¬ãƒ™ãƒ«ã§ã™ãŒã€S3 ã®æ“ä½œãŒè»½ãç†è§£ã§ããŸã®ã§è‰¯ã‹ã£ãŸã§ã™ã€‚

æ¬¡ã¯ã€**ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½**ãƒ»**å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰** ãªã©è©¦ã—ã¦ã¿ãŸã„ã§ã™ã­ã€‚

ç§ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’è¾¼ã‚ãŸå†…å®¹ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
ã‚‚ã£ã¨ã“ã†æ›¸ã„ãŸæ–¹ãŒè‰¯ã„ãªã©ã€æ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆé ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ğŸ™

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ!!


## å‚ç…§


* [Boto3 Docs Quickstart](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html)
* [macOS ã§ã® AWS CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 2 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€æ›´æ–°ã€ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/install-cliv2-mac.html) #1
* [èªè¨¼æƒ…å ±ã®å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ](https://docs.aws.amazon.com/ja_jp/ses/latest/DeveloperGuide/create-shared-credentials-file.html)
* [AWS SDK for Python (Boto3)](https://aws.amazon.com/sdk-for-python/)
* [AWS åˆ©ç”¨ã§ãã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#:\~:text=%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AE%E6%8C%87%E5%AE%9A-,%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3,-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%88%E3%82%8A%E3%80%81%E5%88%A9%E7%94%A8) #2
* [Create an Amazon S3 bucket](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-creating-buckets.html#create-an-amazon-s3-bucket) 
* [https://github.com/aws/aws-cli/issues/2603#issuecomment-349191935](https://github.com/aws/aws-cli/issues/2603#issuecomment-349191935)